<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body><div class="container"><h1>Welcome Developers</h1>
<p>
  While you see this page, obviously this is not a product page. This is for you, our developers.
</p>
<p>
  The purpose of this small preparation project is to example the logic between modules using simple node.js express code. Of course, it is not what the real product will use or looks like. 
</p>
<p> 
  In order to save time, I make everything quick and dirty... well, very dirty I know... The purpose is a better way to explain the biz logic, better than pre markdown documents, because you can try it in your machine and modify code to see the result immedaitely.
</p>
<h2>Disclaimer</h2>
<p>
  Everyone may modify the code and commit without update this document. If you find some link does't work as expected, please go to check the code directly. And if you find this doc is out of date, please just update it. Sometime I update the code without update the doc. It is BAD behavior, I am sorry about it. thank you for your tolerance working with such a bad developer. if you do not, well , <b>send me some eggs</b>
</p>
<img src='./imgs/hitbyeggs.png' class="img-fluid" alt='hit me with eggs.' title='credit: https://www.eastcoastdaily.in/2019/03/19/the-egg-boy-who-attacked-the-australian-senator-with-eggs-for-racist-comments-watch-the-video.html'/>
<p>
  <h3>A list of things I did dirty and why</h3>
  <ul>
      <li>Use mongodb and js to simulate ethereum smart contract. When you create a eth tx actually it saves into mongodb. </li>
      <li>Use mongodb to simulate ethereum state machine. The MAP of peerId to Credit is just a database inside Mongo. </li>
    <li>Use mongodb to simulate p2p network. When you send a message to other nodes, you actually save an item into mongodb</li>
    <li>All TPM communication is a placeholder. You can see "placeholder" everywhere</li>
    <li>When a node is hacked, I created with a "hacked" attribute so everyone know it is hacked. I wish in the real world, we can identify a hacked node this way</li>
    <li>You will need to manually trigger events using URL links below to simulate what happened in real world</li>
  </ul>
</p>
<h1>Some test links</h1>
<p>
  I make most of them a "GET" http action so that you do not need POSTMAN to generate a POST action. But if you do not mind to use POSTMAN, I will provide a POST interface soon later, so that you can easily modify the parameters without store it first into mongodb first.
</p>

<ul>
  <li>
    <h2> Look up Node Creidt from PeerId</h2>
    <p>/checkCredit/:id can list node's credit for node ID is :id<br>
    for example<br>
    <a href='/poc/checkCredit/1'>/poc/checkCredit/1</a> </p>
    <p>
      It returns something like this <br>
      <code>
        {"_id":"5d45086626beac27a5fe87e8","peerId":"1","creditScore":0,"createdAt":"2019-08-03T04:07:02.457Z","updatedAt":"2019-08-03T04:07:02.457Z","__v":0}
      </code>
    </p>
  </li>

  <li>
      <h2>Deposit Escrow Gas Fee for Init Approval Cost before New Node Join Network</h2>
      <p>
        If a node with same PeerId exists in the mongodb, you will see a response like this <code>Please change peerID, since this peerId has existed</code> Just change another peerId and retry.
      </p>
      <p>
        The Escrow gas will not return no matter the init remote attestation approved or rejected. 
      </p>
      <p>
        If you are too poor to pay 10 gas for test purpose, just type "faucet" in the peerId textbox, Santa Claus will pay for you.
      </p>
      <p>
        <form action="/poc/faucetGasToPeer" method="get">
          Ask Santa Claus send Gas To Your PeerId: <input type="text" name="peerId"><br>
          Amount: <input type="text" name="amt"><br>
          <input type="submit" value="Submit">
        </form>
      </p>
      <p>
        <form action="/poc/newJoinNodeDeposit" method="get">
          PeerId: <input type="text" name="peerId"><br>
          Escrow Gas Deposit Amount (must higher than 10): <input type="text" name="depositGasAmt"><br>
          <input type="submit" value="Submit">
        </form>
      </p>
      <p><b>Remember to copy the gasTransactionId._id in the response json. </b>You will need this ID in your further steps</p>

      </p>
 </li>
  <li>
      <h2> New Node Join Network Asking for Initial Remote Attestation</h2>
      <p>If you (or Santa Claus) have paid the deposit in last step, please copy the transaction ID as the Proof of Payment in this step.</p>
      <p>
        Please input your peerId. It has to be a new peerId because only new join node need to do this step. If a node with same PeerId exists in the mongodb, you will see a response like this <code>Please change peerID, since this peerId has existed</code> Just change another peerId and retry.
      </p>
      <p>


          <form action="/poc/newNodeJoin" method="get">
            PeerId: <input type="text" name="peerId"><br>
            Escrow Gas Deposit Tx Id: <input type="text" name="depositGasTxId"><br>
            <input type="radio" name="hacked" value="true" checked> Hacked<br>
            <input type="radio" name="hacked" value="false"> Trustable<br>
            <input type="submit" value="Submit">
          </form>
        </p>
        <p>After submmited. Your node is created and also you will have an account in the Credit system with the initial credit score 0. Because no other trusted nodes validate your Proof of Trust yet. In the next step, you can try other nodes to verify your PoT</p>
        
    </li>

    <li>
      <h2>Manually Change A Node's Score</h2>
      <p>/setPeerScore allows you to manually change a peer (node) credit score.</p>
      <p>In the real world, you certainly cannot do so, this is a big cheat. However, in the demo world, you are God. Do whatever you want.</p>
      <p>
          <form action="/poc/setPeerScore" method="get">
            PeerId: <input type="text" name="peerId"><br>
            New Credit Score: <input type="text" name="score"><br>
            <input type="submit" value="Submit">
          </form>
      </p>
    </li>

    <li>

      <h2>Try to do Remote Attestation from a Regular Node</h2>
      <p>/tryRa simulate a node received a new node join message from P2P network. It will try to win the lottery to do remote attestation. If it is not lucky, response is unlucky. If it is lucky, it will continue to do Remote Attestation and send Eth signed tx so that it will get reward credit and token after others verify</p>
      <p>In this simulation, I used manually trigger by clicking the link below. In the real world, the node who want to paticipate this lottery need to listen to P2P network notification. </p>
      <p>In this simulation, I used Math.Random to simulate VRF. In the real world, we will use VRF Rust Crate to generate the VRF, and use Solidify VRF to verify in smart contract</p>
      <p>In this simulation, I use mongoDB to simulate sending tx to Ethereum and the execution of smart contract is also a node.js simulator triggered by another HTTP GET. </p>
      <p><a href='/poc/tryra?peerId=0&&newJoinTxHash='>click here to try remote attestation</a></p>
      <p>


        <form action="/poc/tryRa" method="get">
          PeerId: <input type="text" name="peerId" value='1'><br>
          PoTHash: <input type="text" name="potHash" value='30e762eff4891a1a99507d7efa7476a99d6343c607c26602f44d9298b7e05a45'><br>
          <input type="submit" value="Submit">
        </form>
      </p>
    </li>
</ul>

<h1>Demo Steps</h1>
<ul>
  <li>
    <h3>Purge database</h3>
    <p>
      Click <a href="/todo"> to clear the database before demo</a>
    </p>
  </li>
  <li>
    <h3>Create 6+ genesis nodes with intial credit 0</h3>
    <p>
        Click <a href="/todo"> to create node peerId is 0, intial credit is 0</a><br>
        Click <a href="/todo"> to create node peerId is 1, intial credit is 0</a><br>
        Click <a href="/todo"> to create node peerId is 2, intial credit is 0</a><br>
        Click <a href="/todo"> to create node peerId is 3, intial credit is 0</a><br>
        Click <a href="/todo"> to create node peerId is 4, intial credit is 0</a><br>
        Click <a href="/todo"> to create node peerId is 5, intial credit is 0</a><br>
      
    </p>

  </li>
  <li>
    
    <h3>Update those genesis nodes with different credit score.</h3>
    <p>
        Click <a href="/todo"> to manually set node peerId whose Id is 0,  credit is 10</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 1,  credit is 100</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 2,  credit is 1000</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 3,  credit is 20</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 4,  credit is 200</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 5,  credit is 2000</a><br>
      
    </p>

  </li>
  <li>
    <h3>A new node join.</h3>
    <p>
        Click <a href="/todo"> to manually trigger node peerId = 6 apply for joinning the trusted network</a><br>
        
    </p>

  </li>
  <li>
      <h3>Genesis nodes (peerId = [0..5]) trying to win the lottery of doing Remote Attestation to this new joined node (peerId =6).</h3>
      <p>
        Click <a href="/todo"> to manually set node peerId whose Id is 0, to try RA</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 1, to try RA</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 2, to try RA0</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 3, to try RA</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 4, to try RA</a><br>
        Click <a href="/todo"> to manually set node peerId whose Id is 5, to try RA</a><br>
      
      </p>
  
    </li>
    <li>
      <h3>Check Credit Score for new join node and RA nodes.</h3>
      <p>
        if the new join nodes has credit score higher than zero, it has passed the initial remote attestation. 

        Click <a href="/todo"> to check credit score for any nodes, Please change the peerId</a><br>
        
      </p>
  
    </li>
    <li>
      <h3>Check Transaction Log.</h3>
      <p>
        Click <a href="/todo"> to check transaction log</a><br>
        
      </p>
  
    </li>
</ul>
</div>
</body>